<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>El Impostor - Prueba Completa</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg:#f8fafc;
            --card:#fff;
            --border:#e2e8f0;
            --accent:#00ABE4;
            --accent-soft:rgba(0,171,228,0.08);
            --danger:#ef4444;
            --danger-soft:rgba(239,68,68,0.06);
            --text:#0f172a;
            --muted:#64748b;
        }

        html.dark{
            --bg:#020617;
            --card:#0f172a;
            --border:#1e293b;
            --accent:#3b82f6;
            --accent-soft:rgba(59,130,246,0.12);
            --text:#f8fafc;
            --muted:#94a3b8;
        }

        *{box-sizing:border-box}
        html,body{
            height:100dvh; width:100vw; margin:0;
            font-family:'Outfit',sans-serif;
            background:var(--bg);
            color:var(--text);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        .app{max-width:440px; margin:0 auto; padding:20px; display:flex; flex-direction:column; min-height:100dvh;}
        header{display:flex; align-items:center; justify-content:space-between; margin-bottom:18px}
        .logo-area h1{font-size:26px; font-weight:800; margin:0}
        .sub{font-size:13px; color:var(--muted); margin-top:4px}
        .status-dot{width:8px;height:8px;background:var(--accent);border-radius:50%;box-shadow:0 0 10px var(--accent)}

        .card{background:var(--card); border:1px solid var(--border); border-radius:20px; padding:20px; margin-bottom:16px; box-shadow:0 10px 30px rgba(16,24,40,0.04)}
        label{font-size:12px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:0.6px; margin-bottom:8px; display:block}

        input,select,button{
            font-family:'Outfit',sans-serif;
        }

        input,select{
            width:100%; padding:14px 16px; border-radius:14px; border:2px solid transparent;
            background:rgba(255,255,255,0.96); color:var(--text); font-size:15px; outline:none;
            transition:box-shadow 0.18s, border-color 0.18s, background 0.18s;
        }

        input:focus,select:focus{ box-shadow:0 6px 20px var(--accent-soft); border-color:var(--accent) }

        .row{display:flex; gap:10px;}
        .smallbtn{width:54px; min-width:54px; padding:0 10px; border-radius:12px; font-weight:800}

        ul{padding:0; margin:10px 0 0 0; list-style:none}
        li{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:transparent; margin-bottom:8px; font-weight:600}

        .btn-icon{background:transparent; border:none; font-size:20px; cursor:pointer; color:var(--muted); padding:6px; border-radius:8px}
        .btn-icon:active{transform:scale(0.96)}

        /* INLINE ERROR (mejor colapso + fade más notable) */
        .inline-error{
            font-size:13px; color:var(--danger); font-weight:700;
            opacity:0; visibility:hidden; transform:translateY(-8px);
            max-height:0; padding:0 10px; margin-top:0; overflow:hidden; border-radius:10px;
            background:transparent;
            transition:
                opacity 0.9s cubic-bezier(0.22,1,0.36,1),
                transform 0.9s cubic-bezier(0.22,1,0.36,1),
                max-height 0.9s cubic-bezier(0.22,1,0.36,1),
                padding 0.6s cubic-bezier(0.22,1,0.36,1),
                margin-top 0.6s cubic-bezier(0.22,1,0.36,1),
                background-color 0.6s;
            line-height:1.2;
        }

        .inline-error.show{
            opacity:1; visibility:visible; transform:translateY(0);
            max-height:84px; padding:8px 10px; margin-top:10px;
            background:var(--danger-soft);
        }

        .inline-error.hide{
            opacity:0; visibility:hidden; transform:translateY(-8px);
            max-height:0; padding:0 10px; margin-top:0;
        }

        /* Reveal / timer / otros (mantengo funcionalidad) */
        .assign-name{font-size:40px; font-weight:900; text-align:center; margin:24px 0}
        .reveal{display:none; padding:32px; border-radius:18px; border:2px solid var(--accent); background:var(--accent-soft); text-align:center; min-height:120px}
        .reveal.impostor-mode{border-color:var(--danger); background:var(--danger-soft)}

        .timer-wrap{position:relative; width:220px; height:220px; margin:10px auto}
        .timer-svg{position:absolute; top:0; left:0; width:100%; height:100%; transform:rotate(-90deg)}
        .circle-bg{fill:none; stroke:rgba(0,0,0,0.05); stroke-width:10}
        .circle-fg{fill:none; stroke:var(--accent); stroke-width:10; stroke-linecap:round; stroke-dasharray:283; transition:stroke-dashoffset 0.1s linear, stroke 0.3s ease; filter:drop-shadow(0 0 6px rgba(0,171,228,0.25))}
        .timer-number{font-size:68px; font-weight:900; text-align:center; z-index:2}

        .vote-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
        .vote-card{padding:18px; border-radius:14px; border:1px solid var(--border); background:transparent; font-weight:800; cursor:pointer; text-align:center}

        .footer{margin-top:auto; color:var(--muted); font-size:12px; text-align:center}

        /* overlays */
        .toast-overlay{position:fixed; top:0; left:0; width:100%; height:100%; display:none; align-items:flex-end; justify-content:center; background:rgba(0,0,0,0.36); z-index:999}
        .toast-overlay.active{display:flex}
        .toast-content{width:100%; max-width:440px; background:var(--card); padding:28px; border-top-left-radius:22px; border-top-right-radius:22px; transform:translateY(100%); transition:transform 0.28s}
        .toast-overlay.active .toast-content{transform:translateY(0)}
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo-area">
                <h1>El Impostor <span class="status-dot" aria-hidden="true"></span></h1>
                <div class="sub">TRAKAS HDSPM</div>
            </div>
            <button onclick="toggleDarkMode()" title="Cambiar tema" style="border-radius:12px;padding:10px;border:1px solid var(--border);background:var(--card)">Tema</button>
        </header>

        <!-- ADMIN -->
        <div id="admin" class="card">
            <label for="nuevaPalabra">Añadir palabra</label>
            <div class="row" style="align-items:center">
                <input id="nuevaPalabra" type="text" placeholder="Ej. Cybertruck, Zumpango..." autocomplete="off" />
                <button class="smallbtn" onclick="agregarPalabra()">+</button>
            </div>
            <div id="errorPalabra" class="inline-error" aria-live="polite"></div>

            <ul id="listaPalabras" aria-label="Lista de palabras"></ul>

            <hr style="margin:18px 0;border:none;border-top:1px solid var(--border)"/>

            <label for="nombreJugador">Añadir jugador</label>
            <div class="row" style="align-items:center">
                <input id="nombreJugador" type="text" placeholder="Nombre del jugador" autocomplete="off" />
                <button class="smallbtn" onclick="agregarJugador()">+</button>
            </div>
            <div id="errorJugador" class="inline-error" aria-live="polite"></div>

            <ul id="listaJugadores" aria-label="Lista de jugadores"></ul>

            <div style="display:flex; gap:12px; margin-top:18px; align-items:flex-end">
                <div style="flex:1">
                    <label for="duracionSelect">Tiempo ronda</label>
                    <select id="duracionSelect">
                        <option value="60" selected>1 minuto</option>
                        <option value="120">2 minutos</option>
                        <option value="180">3 minutos</option>
                        <option value="240">4 minutos</option>
                        <option value="300">5 minutos</option>
                    </select>
                </div>
                <div style="width:140px">
                    <button style="width:100%; height:56px; border-radius:12px" onclick="iniciarJuego()">¡Jugar!</button>
                </div>
            </div>

            <div style="margin-top:12px; display:flex; gap:10px">
                <button style="flex:1; border-radius:12px; border:1px solid var(--border); background:transparent" onclick="mostrarConfirmacion()">Reset Total</button>
            </div>
        </div>

        <!-- ASIGNACION -->
        <div id="asignacion" class="card" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center; opacity:0.7; margin-bottom:8px">
                <div style="font-size:12px; font-weight:800; text-transform:uppercase; color:var(--muted)">Turno de</div>
                <div style="font-variant-numeric:tabular-nums"><span id="indiceAsignacion">1</span> / <span id="totalAsignacion">1</span></div>
            </div>
            <div class="assign-name" id="nombreJugadorAsignacion">Jugador</div>

            <div style="margin-top:14px">
                <div style="position:relative">
                    <button id="btnReveal" class="smallbtn" style="width:100%; padding:22px; border-radius:14px; background:var(--accent-soft); border:2px solid var(--accent); font-weight:900" oncontextmenu="return false">MANTÉN PARA VER TU ROL</button>
                    <div id="textoPalabra" class="reveal" aria-hidden="true"></div>
                </div>
                <button id="btnSiguiente" class="smallbtn" style="width:100%; margin-top:12px; border-radius:12px; border:1px solid var(--border)" onclick="siguienteJugador()">Entendido, siguiente</button>
            </div>
        </div>

        <!-- PISTAS -->
        <div id="pistas" class="card" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <div style="font-size:12px; color:var(--muted); font-weight:700; text-transform:uppercase">Go Go Go</div>
                    <div style="font-weight:900; font-size:18px">Describan la palabra</div>
                </div>
            </div>

            <div class="timer-wrap">
                <svg class="timer-svg" viewBox="0 0 100 100" aria-hidden="true">
                    <circle class="circle-bg" cx="50" cy="50" r="45"></circle>
                    <circle id="timerCircle" class="circle-fg" cx="50" cy="50" r="45"></circle>
                </svg>
                <div class="timer-number" id="timerNumber" aria-live="polite">60</div>
            </div>

            <div style="display:flex; gap:12px; margin-top:8px">
                <button id="botonIniciarTimer" style="flex:1; padding:14px; border-radius:12px; border:1px solid var(--border)" onclick="iniciarTemporizador()">Iniciar</button>
                <button style="flex:1; padding:14px; border-radius:12px; border:1px solid var(--border)" onclick="saltarAPuesta()">Votación</button>
            </div>
        </div>

        <!-- VOTACION -->
        <div id="votacion" class="card" style="display:none">
            <div style="text-align:center; margin-bottom:16px">
                <div style="font-size:12px; color:var(--muted); font-weight:700; text-transform:uppercase">Votación final</div>
                <div style="font-weight:900; font-size:20px">¿Quién es el impostor?</div>
            </div>
            <div id="voteContainer" class="vote-grid"></div>
            <button style="margin-top:14px; width:100%; padding:14px; border-radius:12px" onclick="mostrarResultado()">Ver Resultados</button>
        </div>

        <!-- RESULTADO -->
        <div id="resultado" class="card" style="display:none">
            <div style="text-align:center">
                <div style="font-size:12px; color:var(--muted); font-weight:700; text-transform:uppercase">Resultado</div>
                <div class="result-text" id="textoResultado" style="font-weight:900; font-size:20px; margin-top:6px"></div>
            </div>

            <div id="impostorGuessSection" style="display:none; margin-top:18px; padding:16px; border-radius:12px; border:1px solid var(--danger); background:var(--danger-soft)">
                <label id="impostorGuessLabel" style="display:block; font-weight:900; color:var(--danger); margin-bottom:8px"></label>
                <p style="margin:0 0 12px 0; color:var(--text); opacity:0.9">Si adivinas la palabra, ganas la partida.</p>
                <input id="guessInput" type="text" placeholder="Palabra secreta..." />
                <button style="margin-top:10px; width:100%; padding:12px; border-radius:10px; background:var(--danger); color:white; border:none" onclick="impostorAdivina()">Intentar Adivinar</button>
                <div id="guessFeedback" style="margin-top:8px; font-weight:800; text-align:center"></div>
            </div>

            <div style="margin-top:18px; display:flex; flex-direction:column; gap:10px">
                <button onclick="nuevaRonda()" style="padding:12px; border-radius:12px">Jugar otra vez</button>
                <button onclick="mostrarSeccion('admin')" style="padding:12px; border-radius:12px; border:1px solid var(--border)">Volver al menú</button>
            </div>
        </div>

        <div style="flex:1"></div>
        <footer class="footer">Development by VNGAS</footer>
    </div>

    <!-- Confirm overlay -->
    <div id="toastOverlay" class="toast-overlay" onclick="cerrarConfirmacion()">
        <div class="toast-content" onclick="event.stopPropagation()">
            <div style="font-weight:900; font-size:18px; margin-bottom:8px">¿Reiniciar todo?</div>
            <div style="color:var(--muted); margin-bottom:18px">Se borrarán todos los jugadores y palabras guardadas.</div>
            <div style="display:flex; gap:8px">
                <button style="flex:1; padding:12px; border-radius:10px" onclick="cerrarConfirmacion()">Cancelar</button>
                <button style="flex:1; padding:12px; border-radius:10px; background:var(--danger); color:#fff; border:none" onclick="confirmarReinicio()">Sí, borrar</button>
            </div>
        </div>
    </div>

    <script>
        // Seguridad básica: bloqueo de menú contextual y ciertas teclas (mantener simple)
        (function(){
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.onkeydown = function(e){
                if(e.keyCode === 123) return false; // F12
                if(e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'C' || e.key === 'J')) return false;
                if(e.ctrlKey && e.key === 'U') return false;
            };
        })();

        // Variables del juego
        let palabras = [];
        let palabrasDisponibles = [];
        let jugadores = [];
        let jugadoresMezclados = [];
        let impostor = null;
        let palabraSeleccionada = "";
        let indiceActual = 0;
        let votos = {};
        let duracion = 60;
        let tiempoRestante = 0;
        let timerRunning = false;
        let rafId = null;
        let startTs = null;

        // Guardado / carga
        function guardarDatos(){
            try {
                localStorage.setItem('impostor_palabras', JSON.stringify(palabras));
                localStorage.setItem('impostor_jugadores', JSON.stringify(jugadores));
            } catch(e){}
        }
        function cargarDatos(){
            try {
                const p = localStorage.getItem('impostor_palabras');
                const j = localStorage.getItem('impostor_jugadores');
                if(p) palabras = JSON.parse(p);
                if(j) jugadores = JSON.parse(j);
            } catch(e){}
        }

        // UI helpers
        function toggleDarkMode(){ document.documentElement.classList.toggle('dark') }
        function mostrarSeccion(id){
            const secciones=['admin','asignacion','pistas','votacion','resultado'];
            secciones.forEach(s => {
                const el = document.getElementById(s);
                if(!el) return;
                if(s === id) el.style.display = 'block';
                else el.style.display = 'none';
            });
        }

        // Normalize helpers
        function cleanInput(str){ if(typeof str !== 'string') return ''; return str.replace(/\s+/g,' ').trim(); }
        function normalizeForCompare(str){ if(typeof str !== 'string') return ''; return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
        function existsInArray(arr, value){ const norm = normalizeForCompare(value); return arr.some(item => normalizeForCompare(item) === norm); }

        // Allow only letters (Unicode) and spaces
        function isValidChars(str){ if(typeof str !== 'string') return false; const pattern = /^[\p{L}\s]+$/u; return pattern.test(str); }

        // Inline error handling (con transición suave)
        const inlineErrorTimeouts = {};
        function showInlineError(id, msg, autoHide=true){
            const el = document.getElementById(id);
            if(!el) return;
            if(inlineErrorTimeouts[id]){ clearTimeout(inlineErrorTimeouts[id]); delete inlineErrorTimeouts[id]; }
            el.innerText = msg;
            el.classList.remove('hide');
            void el.offsetWidth;
            el.classList.add('show');
            el.classList.add('inline-visible');
            if(autoHide){
                inlineErrorTimeouts[id] = setTimeout(() => {
                    el.classList.remove('show');
                    el.classList.add('hide');
                    setTimeout(()=>{ el.innerText=''; el.classList.remove('hide'); delete inlineErrorTimeouts[id]; }, 980);
                }, 3200);
            }
        }
        function clearInlineError(id){
            const el = document.getElementById(id);
            if(!el) return;
            if(inlineErrorTimeouts[id]){ clearTimeout(inlineErrorTimeouts[id]); delete inlineErrorTimeouts[id]; }
            el.classList.remove('show','hide');
            el.innerText = '';
        }

        // Render lists
        function renderPalabras(){
            const ul = document.getElementById('listaPalabras');
            ul.innerHTML = '';
            if(palabras.length === 0){
                const li = document.createElement('li');
                li.style.justifyContent = 'center';
                li.style.color = 'var(--muted)';
                li.style.fontStyle = 'italic';
                li.style.border = 'none';
                li.textContent = 'No hay palabras';
                ul.appendChild(li);
                return;
            }
            palabras.forEach((p,i) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${p}</span><button class="btn-icon" aria-label="Eliminar palabra" onclick="eliminarPalabra(${i})">&times;</button>`;
                ul.appendChild(li);
            });
        }

        function renderJugadores(){
            const ul = document.getElementById('listaJugadores');
            ul.innerHTML = '';
            if(jugadores.length === 0){
                const li = document.createElement('li');
                li.style.justifyContent = 'center';
                li.style.color = 'var(--muted)';
                li.style.fontStyle = 'italic';
                li.style.border = 'none';
                li.textContent = 'No hay jugadores';
                ul.appendChild(li);
                return;
            }
            jugadores.forEach((j,i) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${j}</span><button class="btn-icon" aria-label="Eliminar jugador" onclick="eliminarJugador(${i})">&times;</button>`;
                ul.appendChild(li);
            });
        }

        function eliminarPalabra(index){ palabras.splice(index,1); guardarDatos(); renderPalabras(); }
        function eliminarJugador(index){ jugadores.splice(index,1); guardarDatos(); renderJugadores(); }

        // Sanitización en tiempo real: elimina caracteres inválidos y borra campo si detecta caracteres no permitidos (según pedido)
        function attachSanitizers(){
            const inpPal = document.getElementById('nuevaPalabra');
            const inpJug = document.getElementById('nombreJugador');

            function sanitizeEventFactory(inputId){
                return function(e){
                    const el = e.target;
                    const raw = el.value || '';
                    // filtro: permitimos solo letras Unicode (\p{L}) y espacios
                    // Build filtered value
                    const filtered = raw.replace(/[^\p{L}\s]/gu,'');
                    if(filtered !== raw){
                        // si el usuario pegó o tecleó caracteres no permitidos -> borrar campo y mostrar mensaje
                        el.value = '';
                        showInlineError(inputId === 'nuevaPalabra' ? 'errorPalabra' : 'errorJugador', 'Caracteres no permitidos (números, emojis o símbolos). Campo borrado para nuevo intento.');
                        el.focus();
                        return;
                    }
                    // Si pasa, no hacemos nada (solo normalizamos espacios múltiples)
                    // Pero no auto-modificar si no necesario para evitar molestar al usuario
                    const cleaned = filtered.replace(/\s+/g,' ');
                    if(cleaned !== el.value) el.value = cleaned;
                };
            }

            if(inpPal){
                inpPal.addEventListener('input', sanitizeEventFactory('nuevaPalabra'));
                inpPal.addEventListener('paste', function(e){
                    // intercept paste to sanitize immediately
                    const text = (e.clipboardData || window.clipboardData).getData('text') || '';
                    const filtered = text.replace(/[^\p{L}\s]/gu,'');
                    if(filtered !== text){
                        e.preventDefault();
                        showInlineError('errorPalabra', 'Pegado con caracteres no permitidos. Campo borrado.');
                        // no pegar nada
                        this.value = '';
                        return;
                    }
                });
                inpPal.addEventListener('focus', ()=> clearInlineError('errorPalabra'));
            }

            if(inpJug){
                inpJug.addEventListener('input', sanitizeEventFactory('nombreJugador'));
                inpJug.addEventListener('paste', function(e){
                    const text = (e.clipboardData || window.clipboardData).getData('text') || '';
                    const filtered = text.replace(/[^\p{L}\s]/gu,'');
                    if(filtered !== text){
                        e.preventDefault();
                        showInlineError('errorJugador', 'Pegado con caracteres no permitidos. Campo borrado.');
                        this.value = '';
                        return;
                    }
                });
                inpJug.addEventListener('focus', ()=> clearInlineError('errorJugador'));
            }
        }

        // Add / remove entries (validations enforced)
        function agregarPalabra(){
            const input = document.getElementById('nuevaPalabra');
            const raw = input.value;
            const cleaned = cleanInput(raw);

            clearInlineError('errorPalabra');

            if(!cleaned || cleaned.length < 2){
                showInlineError('errorPalabra','Mínimo 2 caracteres.');
                input.focus();
                return;
            }
            if(cleaned.length > 20){
                showInlineError('errorPalabra','Máximo 20 caracteres.');
                input.focus();
                return;
            }
            if(!isValidChars(cleaned)){
                // borrar campo según pedido y mostrar mensaje
                input.value = '';
                showInlineError('errorPalabra','Solo letras y espacios permitidos. Campo borrado.');
                input.focus();
                return;
            }
            if(existsInArray(palabras, cleaned)){
                input.value = '';
                showInlineError('errorPalabra', `La palabra "${cleaned}" ya existe. Campo borrado para ingresar otra.`);
                input.focus();
                return;
            }

            palabras.push(cleaned);
            guardarDatos();
            renderPalabras();
            input.value = '';
            input.focus();
        }

        function agregarJugador(){
            const input = document.getElementById('nombreJugador');
            const raw = input.value;
            const cleaned = cleanInput(raw);

            clearInlineError('errorJugador');

            if(!cleaned || cleaned.length < 2){
                showInlineError('errorJugador','Mínimo 2 caracteres.');
                input.focus();
                return;
            }
            if(cleaned.length > 20){
                showInlineError('errorJugador','Máximo 20 caracteres.');
                input.focus();
                return;
            }
            if(!isValidChars(cleaned)){
                input.value = '';
                showInlineError('errorJugador','Solo letras y espacios permitidos. Campo borrado.');
                input.focus();
                return;
            }
            if(existsInArray(jugadores, cleaned)){
                input.value = '';
                showInlineError('errorJugador', `El jugador "${cleaned}" ya existe. Campo borrado para ingresar otro.`);
                input.focus();
                return;
            }

            jugadores.push(cleaned);
            guardarDatos();
            renderJugadores();
            input.value = '';
            input.focus();
        }

        // Confirm overlay
        function mostrarConfirmacion(){
            const ov = document.getElementById('toastOverlay');
            ov.classList.add('active');
            ov.style.display = 'flex';
        }
        function cerrarConfirmacion(){
            const ov = document.getElementById('toastOverlay');
            ov.classList.remove('active');
            setTimeout(()=>{ ov.style.display='none'; }, 300);
        }
        function confirmarReinicio(){
            palabras = []; jugadores = [];
            try { localStorage.removeItem('impostor_palabras'); localStorage.removeItem('impostor_jugadores'); } catch(e){}
            renderPalabras(); renderJugadores();
            cerrarConfirmacion();
            mostrarSeccion('admin');
        }

        // Juego: mezclar, asignación, temporizador y votación (simplificado pero funcional)
        function mezclarArray(arr){
            for(let i=arr.length-1;i>0;i--){
                const j = Math.floor(Math.random()*(i+1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function iniciarJuego(){
            if(jugadores.length < 3){
                alert('Se requieren al menos 3 jugadores.');
                return;
            }
            if(palabras.length === 0){
                alert('Agrega al menos una palabra.');
                return;
            }
            duracion = Number(document.getElementById('duracionSelect').value) || 60;
            palabrasDisponibles = [...palabras];
            nuevaRonda();
        }

        function nuevaRonda(){
            votos = {};
            document.getElementById('guessFeedback').innerText = '';
            document.getElementById('guessInput') && (document.getElementById('guessInput').value = '');
            document.getElementById('impostorGuessSection') && (document.getElementById('impostorGuessSection').style.display = 'none');

            if(palabrasDisponibles.length === 0){
                alert('No quedan palabras nuevas. Vuelve a cargar o reinicia la lista.');
                mostrarSeccion('admin');
                return;
            }

            const randomIndex = Math.floor(Math.random()*palabrasDisponibles.length);
            palabraSeleccionada = palabrasDisponibles[randomIndex];
            palabrasDisponibles.splice(randomIndex,1);

            jugadoresMezclados = mezclarArray([...jugadores]);
            impostor = jugadoresMezclados[Math.floor(Math.random()*jugadoresMezclados.length)];
            indiceActual = 0;
            document.getElementById('totalAsignacion').innerText = jugadoresMezclados.length;
            cargarJugador();
            mostrarSeccion('asignacion');

            stopTemporizador();
            tiempoRestante = duracion;
            actualizarTimerUI(duracion);
        }

        function cargarJugador(){
            const jugador = jugadoresMezclados[indiceActual];
            document.getElementById('nombreJugadorAsignacion').innerText = jugador;
            document.getElementById('indiceAsignacion').innerText = (indiceActual+1);
            const elem = document.getElementById('textoPalabra');
            elem.style.display = 'none';
            elem.className = 'reveal';
            const btn = document.getElementById('btnReveal');
            btn.style.display = 'block';
            document.getElementById('btnSiguiente').disabled = true;
        }

        function siguienteJugador(){
            document.getElementById('textoPalabra').style.display = 'none';
            indiceActual++;
            if(indiceActual >= jugadoresMezclados.length){
                prepararVotacion();
                mostrarSeccion('pistas');
                return;
            }
            cargarJugador();
        }

        // Reveal logic: hold to reveal; hide on mouseup/touchend
        const btnReveal = document.getElementById('btnReveal');
        const revealBox = document.getElementById('textoPalabra');
        function showContent(e){
            if(e.cancelable && e.type === 'touchstart') e.preventDefault();
            const jugador = jugadoresMezclados[indiceActual];
            if(jugador === impostor){
                revealBox.className = 'reveal impostor-mode';
                revealBox.innerHTML = `<div style="font-weight:800; font-size:14px">Tu misión</div><div style="font-size:28px; font-weight:900; color:var(--danger); margin-top:8px">IMPOSTOR</div><div style="margin-top:8px; color:var(--muted)">Engaña a todos</div>`;
            } else {
                revealBox.className = 'reveal';
                revealBox.innerHTML = `<div style="font-weight:700; font-size:13px; text-transform:uppercase; color:var(--muted)">La palabra es</div><div style="font-size:28px; font-weight:900; margin-top:10px">${palabraSeleccionada}</div>`;
            }
            btnReveal.style.display = 'none';
            revealBox.style.display = 'block';
            document.getElementById('btnSiguiente').disabled = false;

            document.addEventListener('mouseup', hideContent);
            document.addEventListener('touchend', hideContent);
            document.addEventListener('touchcancel', hideContent);
        }
        function hideContent(){
            revealBox.style.display = 'none';
            btnReveal.style.display = 'block';
            document.removeEventListener('mouseup', hideContent);
            document.removeEventListener('touchend', hideContent);
            document.removeEventListener('touchcancel', hideContent);
        }
        if(btnReveal){
            btnReveal.addEventListener('mousedown', showContent);
            btnReveal.addEventListener('touchstart', showContent, {passive:false});
        }

        // Timer
        function iniciarTemporizador(){
            const btn = document.getElementById('botonIniciarTimer');
            if(timerRunning){
                stopTemporizador();
                btn.innerText = 'Reanudar';
                return;
            }
            if(tiempoRestante <= 0) tiempoRestante = duracion;
            btn.innerText = 'Pausar';
            timerRunning = true;
            startTs = performance.now() - ((duracion - tiempoRestante) * 1000);
            function tick(now){
                const elapsed = (now - startTs)/1000;
                tiempoRestante = Math.max(0, duracion - elapsed);
                actualizarTimerUI(tiempoRestante);
                if(tiempoRestante > 0 && timerRunning){
                    rafId = requestAnimationFrame(tick);
                } else {
                    timerRunning = false; rafId = null;
                    if(window.navigator.vibrate) navigator.vibrate([200,100,200]);
                    mostrarAlertaTiempo();
                }
            }
            rafId = requestAnimationFrame(tick);
        }
        function stopTemporizador(){ timerRunning = false; if(rafId) cancelAnimationFrame(rafId); rafId = null; }
        function actualizarTimerUI(segundos){
            const numElem = document.getElementById('timerNumber');
            const circle = document.getElementById('timerCircle');
            const dur = Number(document.getElementById('duracionSelect').value || 60);
            if(numElem) numElem.innerText = Math.ceil(segundos);
            const pct = Math.max(0, Math.min(1, segundos / dur));
            const circumference = 283;
            const offset = circumference - (pct * circumference);
            if(circle) circle.style.strokeDashoffset = offset;
            // critical style last 15s
            const wrapper = document.querySelector('.timer-wrap');
            if(segundos <= 15){
                wrapper && wrapper.classList.add('critical');
                circle && circle.setAttribute('stroke','var(--danger)');
                numElem && numElem.style.color = 'var(--danger)';
            } else {
                wrapper && wrapper.classList.remove('critical');
                circle && circle.setAttribute('stroke','var(--accent)');
                numElem && (numElem.style.color = '');
            }
        }

        function mostrarAlertaTiempo(){
            alert('Tiempo terminado. Es momento de votar.');
            saltarAPuesta();
        }

        function saltarAPuesta(){
            stopTemporizador();
            prepararVotacion();
            mostrarSeccion('votacion');
        }

        // Votacion
        function prepararVotacion(){
            const container = document.getElementById('voteContainer');
            container.innerHTML = '';
            container.classList.remove('has-selection');
            votos = {};
            jugadores.forEach(jugador => {
                const btn = document.createElement('button');
                btn.className = 'vote-card';
                btn.innerText = jugador;
                btn.onclick = function(){ registrarVotoUnico(jugador, btn); };
                container.appendChild(btn);
            });
        }

        function registrarVotoUnico(elegido, btnElement){
            const container = document.getElementById('voteContainer');
            const allBtns = container.querySelectorAll('.vote-card');
            let already = btnElement.classList.contains('voted');
            allBtns.forEach(b => { b.classList.remove('voted'); b.innerText = b.innerText.split('\n')[0]; });
            votos = {};
            if(!already){
                votos[elegido] = 1;
                container.classList.add('has-selection');
                btnElement.classList.add('voted');
                btnElement.innerText = 'Eliminar a\n' + elegido;
                if(window.navigator.vibrate) navigator.vibrate(50);
            } else {
                container.classList.remove('has-selection');
            }
        }

        function mostrarResultado(){
            let masVotado = null; let max = -1;
            for(const k in votos){ if(votos[k] > max){ max = votos[k]; masVotado = k; } }
            const res = document.getElementById('textoResultado');
            const htmlPalabra = `<div style="margin-top:10px;color:var(--muted)">La palabra era <strong style="color:var(--text)">${palabraSeleccionada}</strong></div>`;
            if(!masVotado){
                res.innerHTML = `El impostor era <strong style="color:var(--danger)">${impostor}</strong>.${htmlPalabra}`;
            } else if(masVotado === impostor){
                res.innerHTML = `Correcto — el impostor era <strong style="color:var(--danger)">${impostor}</strong>.${htmlPalabra}`;
            } else {
                res.innerHTML = `Fallaron — el impostor era <strong style="color:var(--danger)">${impostor}</strong>.${htmlPalabra}`;
            }
            document.getElementById('impostorGuessSection') && (document.getElementById('impostorGuessSection').style.display = 'none');
            mostrarSeccion('resultado');
        }

        function impostorAdivina(){
            const intento = (document.getElementById('guessInput') && document.getElementById('guessInput').value.trim()) || '';
            const feed = document.getElementById('guessFeedback');
            if(!intento){ feed.innerText = 'Escribe algo primero.'; feed.style.color = ''; return; }
            if(intento.toLowerCase() === palabraSeleccionada.toLowerCase()){
                feed.style.color = '#10b981'; feed.innerText = '¡INCREÍBLE! Ganaste.';
            } else {
                feed.style.color = 'var(--danger)'; feed.innerText = `Nop. Era "${palabraSeleccionada}".`;
            }
        }

        // Keyboard shortcuts: Enter to add
        document.addEventListener('keydown', e => {
            if(e.key === 'Enter'){
                const f = document.activeElement;
                if(f && f.id === 'nuevaPalabra') agregarPalabra();
                if(f && f.id === 'nombreJugador') agregarJugador();
                if(f && f.id === 'guessInput') impostorAdivina();
            }
        });

        // Inicialización
        cargarDatos();
        renderPalabras();
        renderJugadores();
        attachSanitizers();
        mostrarSeccion('admin');

        // Typewriter title (estético)
        (function(){
            const titleEl = document.querySelector('.logo-area h1');
            const text = "El Impostor";
            let idx = 0;
            titleEl.childNodes[0] && (titleEl.childNodes[0].nodeValue = '');
            function tw(){
                if(idx < text.length){ titleEl.childNodes[0].nodeValue += text.charAt(idx); idx++; setTimeout(tw, 110); }
                else setTimeout(()=>{ titleEl.childNodes[0].nodeValue = ''; idx=0; tw(); }, 8000);
            }
            // ensure a text node exists
            if(!titleEl.firstChild) titleEl.appendChild(document.createTextNode(''));
            setTimeout(tw, 300);
        })();

        // Protect against gestures that zoom etc.
        document.addEventListener('gesturestart', e => e.preventDefault());
        document.addEventListener('touchmove', function(e){ if(e.touches && e.touches.length>1) e.preventDefault(); }, {passive:false});

    </script>
</body>
</html>