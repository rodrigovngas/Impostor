<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
    <title>El Impostor</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* ----------------------------------------------------
           VARIABLES & TEMAS
        ---------------------------------------------------- */
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --card-border: #e2e8f0;
            --card-shadow: 0 20px 40px -10px rgba(148, 163, 184, 0.15);

            --text-main: #0f172a;
            --text-muted: #64748b;

            --input-bg: #f1f5f9;
            --input-border: transparent;

            --item-bg: #ffffff;
            --item-border: #f1f5f9;

            /* MODO CLARO (#00ABE4) */
            --accent: #00ABE4;
            --accent-soft: rgba(0, 171, 228, 0.08);
            --accent-glow: rgba(0, 171, 228, 0.4);

            --danger: #ef4444;
            --danger-soft: rgba(239, 68, 68, 0.1);
            --danger-glow: rgba(239, 68, 68, 0.4);

            --dot-color: #cbd5e1;
        }

        html.dark {
            --bg-color: #020617;
            --card-bg: #0f172a;
            --card-border: #1e293b;
            --card-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6);

            --text-main: #f8fafc;
            --text-muted: #94a3b8;

            --input-bg: #1e293b;
            --input-border: transparent;

            --item-bg: #1e293b;
            --item-border: #334155;

            /* MODO OSCURO (#2272FF) */
            --accent: #3b82f6;
            --accent-soft: rgba(59, 130, 246, 0.15);
            --accent-glow: rgba(59, 130, 246, 0.5);

            --dot-color: #1e293b;
        }

        /* ----------------------------------------------------
           ESTILOS GLOBALES
        ---------------------------------------------------- */
        html,
        body {
            height: 100dvh;
            width: 100vw;
            margin: 0;
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--dot-color) 1.5px, transparent 1.5px);
            background-size: 32px 32px;
            background-attachment: fixed;
            color: var(--text-main);
            overflow-x: hidden;
            overflow-y: auto;
            overscroll-behavior-y: none;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            transition: color 0.4s ease, background-color 0.4s ease;
            cursor: default;
            touch-action: manipulation;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        input, select {
            user-select: text;
        }

        .app {
            max-width: 440px;
            width: 100%;
            min-height: 100dvh;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER & DARK MODE --- */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .logo-area h1 {
            font-size: 26px;
            font-weight: 800;
            margin: 0;
            line-height: 1;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background-color: var(--accent);
            border-radius: 50%;
            display: inline-block;
            margin-left: 6px;
            box-shadow: 0 0 10px var(--accent);
            animation: breath 2s infinite;
        }

        @keyframes breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .dark-toggle {
            cursor: pointer;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            width: 48px;
            height: 48px;
            border-radius: 16px;
            position: relative;
            color: var(--text-main);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .dark-toggle svg {
            width: 22px;
            height: 22px;
            stroke: currentColor;
            position: absolute;
            top: 50%;
            left: 50%;
            transition: all 0.5s ease;
        }

        .icon-moon { opacity: 1; transform: translate(-50%, -50%) rotate(0deg) scale(1); }
        .icon-sun { opacity: 0; transform: translate(-50%, -50%) rotate(90deg) scale(0.5); }
        html.dark .icon-moon { opacity: 0; transform: translate(-50%, -50%) rotate(-90deg) scale(0.5); }
        html.dark .icon-sun { opacity: 1; transform: translate(-50%, -50%) rotate(0deg) scale(1); }

        /* --- COMPONENTS --- */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 28px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            margin-bottom: 16px;
            backdrop-filter: blur(20px);
            animation: slideUpFade 0.5s ease;
        }

        @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 10px;
            padding-left: 4px;
            text-transform: uppercase;
        }

        input, select {
            width: 100%;
            padding: 16px 20px;
            border-radius: 18px;
            border: 2px solid transparent;
            background: var(--input-bg);
            color: var(--text-main);
            font-size: 16px;
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            box-sizing: border-box;
            outline: none;
        }

        input:focus, select:focus {
            background: var(--card-bg);
            border-color: var(--accent);
            box-shadow: 0 4px 20px var(--accent-soft);
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            border-radius: 18px;
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            cursor: pointer;
            width: 100%;
            min-height: 56px;
            transition: transform 0.1s;
        }

        button:active { transform: scale(0.96); }
        button.primary { background: var(--accent); color: #fff; box-shadow: 0 10px 20px var(--accent-soft); }
        button.danger { border-color: var(--danger); color: var(--danger); }
        
        /* Listas */
        ul { padding: 0; margin: 10px 0 0 0; list-style: none; }
        li {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--item-bg);
            border: 1px solid var(--item-border);
            padding: 14px 18px;
            border-radius: 16px;
            font-weight: 500;
        }
        
        .smallbtn { width: 50px; min-width: 50px; padding: 0; margin-left: 8px; font-size: 20px; }
        .row { display: flex; align-items: center; }

        /* --- BLUR EN PALABRAS (FEATURE) --- */
        #listaPalabras li span {
            color: transparent;
            text-shadow: 0 0 10px var(--text-main);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #listaPalabras li span:active, #listaPalabras li span:hover {
            color: var(--text-main);
            text-shadow: none;
        }

        /* --- GAME SCREENS --- */
        .screen { display: none; } /* Ocultar pantallas por defecto */
        
        .hold-btn {
            height: 200px;
            border: 2px dashed var(--accent);
            background: var(--accent-soft);
            color: var(--accent);
            display: flex;
            flex-direction: column;
            user-select: none;
        }
        .hold-btn:active { background: var(--accent); color: white; border-style: solid; }

        .reveal-box {
            display: none;
            margin-top: 20px;
            text-align: center;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 24px;
            border: 2px solid var(--accent);
            box-shadow: 0 10px 40px var(--accent-soft);
        }

        /* --- NUEVO TIMER CIRCULAR --- */
        .circular-timer {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 140px;
            height: 140px;
            margin: 20px auto 30px auto;
        }

        .progress-ring { transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        .progress-ring__circle {
            transition: stroke-dashoffset 0.1s linear, stroke 0.3s ease;
            stroke-linecap: round;
            transform-origin: 50% 50%;
            stroke-dasharray: 326.72 326.72; /* Para radio 52 */
            stroke-dashoffset: 0;
        }

        .timer-number-centered {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .secret-word {
            font-size: 2rem;
            font-weight: 900;
            text-align: center;
            margin: 20px 0;
            letter-spacing: 2px;
            filter: blur(5px);
            transition: filter 0.3s;
        }
        .secret-word:active { filter: blur(0); }

        .vote-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        .vote-card {
            background: var(--item-bg);
            border: 2px solid var(--item-border);
            padding: 20px;
            border-radius: 18px;
            text-align: center;
            font-weight: 700;
            cursor: pointer;
        }
        .vote-card.selected {
            border-color: var(--accent);
            background: var(--accent-soft);
            color: var(--accent);
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div class="logo-area">
                <h1>El Impostor<span class="status-dot"></span></h1>
                <div style="font-size:12px; color:var(--text-muted); font-weight:600;">TRAKAS HDSPM</div>
            </div>
            <button class="dark-toggle" onclick="toggleDarkMode()">
                <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            </button>
        </header>

        <div id="admin" class="card screen" style="display:block;">
            <label>Configuración</label>
            <div class="row" style="margin-bottom:15px;">
                <input type="text" id="nuevaPalabra" placeholder="Añadir palabra..." />
                <button class="smallbtn" onclick="agregarPalabra()">+</button>
            </div>
            <ul id="listaPalabras"></ul>
            
            <div class="row" style="margin-top:20px; margin-bottom:15px;">
                <input type="text" id="nombreJugador" placeholder="Nombre jugador..." />
                <button class="smallbtn" onclick="agregarJugador()">+</button>
            </div>
            <ul id="listaJugadores"></ul>

            <div style="margin-top:20px;">
                <label>Tiempo de Ronda</label>
                <select id="duracionSelect">
                    <option value="60">1 minuto</option>
                    <option value="120">2 minutos</option>
                    <option value="180">3 minutos</option>
                </select>
            </div>

            <button class="primary" style="margin-top:30px;" onclick="comenzarJuego()">COMENZAR JUEGO</button>
        </div>

        <div id="juego" class="card screen">
            <h2 style="text-align:center; margin-bottom:5px;" id="tituloTurno">Turno de...</h2>
            <p style="text-align:center; color:var(--text-muted); margin-top:0;">Pásale el celular al jugador.</p>
            
            <button id="btnRevelar" class="hold-btn" ontouchstart="empezarRevelar()" ontouchend="terminarRevelar()" onmousedown="empezarRevelar()" onmouseup="terminarRevelar()" onmouseleave="terminarRevelar()">
                <span style="font-size:40px; margin:auto;">MANTÉN PRESIONADO<br>PARA VER TU ROL</span>
            </button>

            <div id="cajaRevelacion" class="reveal-box">
                <div style="font-size:14px; text-transform:uppercase; color:var(--text-muted);">Tu palabra secreta es:</div>
                <div id="palabraRol" style="font-size:32px; font-weight:900; margin:15px 0;">????</div>
                <button class="primary" onclick="siguienteJugador()">ENTENDIDO</button>
            </div>
        </div>

        <div id="pistas" class="card screen">
            <h2 style="text-align:center; margin:0; color:var(--text-muted); font-size:16px;">Tiempo Restante</h2>
            
            <div class="circular-timer">
                <svg class="progress-ring" width="120" height="120">
                    <circle class="progress-ring__circle-bg" stroke="var(--input-bg)" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                    <circle class="progress-ring__circle" stroke="var(--accent)" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                </svg>
                <div class="timer-number-centered" id="timerValue">60</div>
            </div>

            <div style="text-align:center;">
                <p style="color:var(--text-muted);">Mantén presionado abajo para recordar tu palabra</p>
                <div id="palabraRecordatorio" class="secret-word">????</div>
            </div>

            <button class="primary" style="margin-top:20px;" onclick="finalizarDiscusion()">FINALIZAR DISCUSIÓN</button>
        </div>

        <div id="votacion" class="card screen">
            <h2 style="text-align:center;">¿Quién es el impostor?</h2>
            <div id="gridVotacion" class="vote-grid"></div>
            <button class="danger" style="margin-top:30px;" onclick="verificarVotacion()">PROCEDER</button>
        </div>

        <div id="resultados" class="card screen" style="text-align:center;">
            <h1 id="textoResultado" style="font-size:40px; line-height:1;">GANAN LOS CIUDADANOS</h1>
            <p id="subtextoResultado" style="color:var(--text-muted);">El impostor era...</p>
            <button class="primary" style="margin-top:30px;" onclick="reiniciarJuego()">JUGAR OTRA VEZ</button>
        </div>

    </div>

    <script>
        /* --- ESTADO DEL JUEGO --- */
        let palabras = JSON.parse(localStorage.getItem('palabras')) || ['Pizza', 'Tacos', 'Sushi'];
        let jugadores = JSON.parse(localStorage.getItem('jugadores')) || ['Jugador 1', 'Jugador 2', 'Jugador 3'];
        let turnoActual = 0;
        let roles = []; // { nombre: "Juan", esImpostor: false, palabra: "Pizza" }
        let palabraDeLaRonda = "";
        let impostorIndex = -1;
        let timerInterval;

        // Render inicial
        renderPalabras();
        renderJugadores();
        actualizarTema();

        /* --- FUNCIONES UI GENERALES --- */
        function actualizarTema() {
            if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
        }
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        function mostrarSeccion(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        /* --- ADMINISTRACIÓN --- */
        function agregarPalabra() {
            const input = document.getElementById('nuevaPalabra');
            const val = input.value.trim();
            if(val) {
                palabras.push(val);
                localStorage.setItem('palabras', JSON.stringify(palabras));
                input.value = '';
                renderPalabras();
            }
        }
        function renderPalabras() {
            const ul = document.getElementById('listaPalabras');
            ul.innerHTML = palabras.map((p, i) => `
                <li><span>${p}</span> <button class="smallbtn" style="color:var(--danger); border-color:var(--danger);" onclick="eliminarItem('palabras', ${i})">×</button></li>
            `).join('');
        }
        function agregarJugador() {
            const input = document.getElementById('nombreJugador');
            const val = input.value.trim();
            if(val) {
                jugadores.push(val);
                localStorage.setItem('jugadores', JSON.stringify(jugadores));
                input.value = '';
                renderJugadores();
            }
        }
        function renderJugadores() {
            const ul = document.getElementById('listaJugadores');
            ul.innerHTML = jugadores.map((j, i) => `
                <li>${j} <button class="smallbtn" style="color:var(--danger); border-color:var(--danger);" onclick="eliminarItem('jugadores', ${i})">×</button></li>
            `).join('');
        }
        function eliminarItem(tipo, index) {
            if(tipo === 'palabras') { palabras.splice(index, 1); localStorage.setItem('palabras', JSON.stringify(palabras)); renderPalabras(); }
            else { jugadores.splice(index, 1); localStorage.setItem('jugadores', JSON.stringify(jugadores)); renderJugadores(); }
        }

        /* --- LÓGICA DEL JUEGO --- */
        function comenzarJuego() {
            if(jugadores.length < 3) return alert("Mínimo 3 jugadores");
            if(palabras.length < 1) return alert("Añade palabras");

            // Fisher-Yates shuffle para aleatoriedad real
            palabraDeLaRonda = palabras[Math.floor(Math.random() * palabras.length)];
            impostorIndex = Math.floor(Math.random() * jugadores.length);
            
            // Crear roles mezclando jugadores
            let indices = jugadores.map((_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }

            roles = [];
            jugadores.forEach((nombre, i) => {
                let esImpostor = (i === impostorIndex);
                roles.push({
                    nombre: nombre,
                    esImpostor: esImpostor,
                    palabra: esImpostor ? "IMPOSTOR" : palabraDeLaRonda
                });
            });

            // Reordenar roles para que no coincida el orden de ingreso
            // (Opcional, pero bueno para evitar trampas visuales)
            
            turnoActual = 0;
            prepararTurno();
            mostrarSeccion('juego');
        }

        function prepararTurno() {
            document.getElementById('tituloTurno').innerText = `Turno de ${roles[turnoActual].nombre}`;
            document.getElementById('btnRevelar').style.display = 'flex';
            document.getElementById('cajaRevelacion').style.display = 'none';
        }

        /* --- REVELACIÓN DE ROL (HOLD BUTTON) --- */
        let pressTimer;
        function empezarRevelar() {
            pressTimer = setTimeout(() => {
                document.getElementById('btnRevelar').style.display = 'none';
                const box = document.getElementById('cajaRevelacion');
                box.style.display = 'block';
                
                const data = roles[turnoActual];
                const pRol = document.getElementById('palabraRol');
                pRol.innerText = data.palabra;
                
                if(data.esImpostor) {
                    pRol.style.color = 'var(--danger)';
                    box.style.borderColor = 'var(--danger)';
                } else {
                    pRol.style.color = 'var(--text-main)';
                    box.style.borderColor = 'var(--accent)';
                }
            }, 800); // 800ms para revelar
        }
        function terminarRevelar() {
            clearTimeout(pressTimer);
        }

        function siguienteJugador() {
            turnoActual++;
            if(turnoActual < roles.length) {
                prepararTurno();
            } else {
                iniciarRondaDiscusion();
            }
        }

        /* --- RONDA DE DISCUSIÓN & TIMER CIRCULAR --- */
        function iniciarRondaDiscusion() {
            mostrarSeccion('pistas');
            iniciarTemporizador();
            
            // Asignar palabra secreta al recordatorio (borrosa por CSS)
            // Nota: Aquí no sabemos quién está mirando, así que ponemos la palabra
            // o un texto genérico. Lo ideal es que cada uno recuerde su palabra.
            // Para evitar trampas, mostraremos "?????" y solo si eres el ciudadano...
            // Simplificación: Mostramos la palabra CIUDADANA. El impostor debe fingir que esa es su palabra.
            document.getElementById('palabraRecordatorio').innerText = palabraDeLaRonda; 
        }

        function actualizarTimerUI(tiempoRestante, duracionTotal) {
            const timerVal = document.getElementById('timerValue');
            const circle = document.querySelector('.progress-ring__circle');
            
            if (!timerVal || !circle) return;

            // 1. Texto
            timerVal.innerText = Math.ceil(tiempoRestante);

            // 2. Progreso SVG
            const radio = 52;
            const circunferencia = 2 * Math.PI * radio; 
            // Clamp entre 0 y 1
            const pct = Math.max(0, Math.min(1, tiempoRestante / duracionTotal));
            const offset = circunferencia - (pct * circunferencia);
            
            circle.style.strokeDashoffset = offset;

            // 3. Color
            if (pct <= 0.25) {
                circle.style.stroke = 'var(--danger)';
                timerVal.style.color = 'var(--danger)';
            } else {
                circle.style.stroke = 'var(--accent)';
                timerVal.style.color = 'var(--text-main)';
            }
        }

        function iniciarTemporizador() {
            if (timerInterval) clearInterval(timerInterval);

            const select = document.getElementById('duracionSelect');
            let duracion = select ? parseInt(select.value) : 60;
            let tiempoRestante = duracion;

            actualizarTimerUI(tiempoRestante, duracion);

            timerInterval = setInterval(() => {
                tiempoRestante -= 0.1;
                actualizarTimerUI(tiempoRestante, duracion);

                if (tiempoRestante <= 0) {
                    clearInterval(timerInterval);
                    navigator.vibrate([200, 100, 200]); // Vibrar si es móvil
                    alert("¡Tiempo Agotado! A votar.");
                    finalizarDiscusion();
                }
            }, 100);
        }

        function finalizarDiscusion() {
            clearInterval(timerInterval);
            renderVotacion();
            mostrarSeccion('votacion');
        }

        /* --- VOTACIÓN --- */
        let votoSeleccionado = null;
        function renderVotacion() {
            const grid = document.getElementById('gridVotacion');
            grid.innerHTML = roles.map((jugador, i) => `
                <div class="vote-card" onclick="seleccionarVoto(this, ${i})">
                    ${jugador.nombre}
                </div>
            `).join('');
            votoSeleccionado = null;
        }

        function seleccionarVoto(elem, index) {
            document.querySelectorAll('.vote-card').forEach(c => c.classList.remove('selected'));
            elem.classList.add('selected');
            votoSeleccionado = index;
        }

        function verificarVotacion() {
            if(votoSeleccionado === null) return alert("Selecciona a alguien.");
            
            const sospechoso = roles[votoSeleccionado];
            mostrarResultados(sospechoso.esImpostor);
        }

        function mostrarResultados(victoriaCiudadana) {
            mostrarSeccion('resultados');
            const h1 = document.getElementById('textoResultado');
            const p = document.getElementById('subtextoResultado');
            const impostorNombre = roles.find(r => r.esImpostor).nombre;

            if(victoriaCiudadana) {
                h1.innerText = "¡GANAN LOS CIUDADANOS!";
                h1.style.color = 'var(--accent)';
                p.innerText = `Correcto. ${impostorNombre} era el Impostor.`;
            } else {
                h1.innerText = "¡GANA EL IMPOSTOR!";
                h1.style.color = 'var(--danger)';
                p.innerText = `Se equivocaron. El Impostor era ${impostorNombre}.`;
            }
        }

        function reiniciarJuego() {
            mostrarSeccion('admin');
        }
    </script>
</body>
</html>